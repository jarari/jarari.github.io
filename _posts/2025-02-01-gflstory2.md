---
title: >
    소녀전선 2 스토리 뷰어 제작기 (2) 데이터 수집 2
tags: [GFL2, React]
style: border
color: primary
description: >
    스토리를 편하게 읽고 싶어서 웹사이트를 만들게 된 이야기
---

### 사라진 에셋 번들
![GFL2Bundles](assets/gfl2bundles.png)
좌측은 한국 서버의 에셋 번들 목록이고 우측은 중국 서버의 에셋 번들 목록입니다. 차이가 보이시나요?<br>
<br>
신기하게도 512kb 이하의 파일들이 3개만 빼고 모두 자취를 감춘 모습입니다. 1년동안 쌓인 컨텐츠와 리소스가 있고 용량도 증가하였는데 파일은 약 11600개에서 약 3500개로 줄어들었습니다. 그렇다면 번들이 합쳐진걸까요? 3500개의 번들을 모두 복호화하여 둘러보아도 일부 파일들이 보이지 않았습니다.<br>

![GFL2Catalog](assets/gfl2catalog.png)
유니티 게임에서 번들을 찾을 때엔 무조건 Addressable부터 뒤져보는게 상책입니다. 문제는 이 게임이 카탈로그조차 json이 아닌 바이너리 카탈로그를 사용한다는 점이죠. 다행히도, [AddressableTools](https://github.com/nesrak1/AddressablesTools) 라는 바이너리 카탈로그를 읽을 수 있을 것만 같은 라이브러리를 찾았고, 시도해보았으나 실패했습니다.<br>
저는 원인 분석을 시작했습니다. AddressableTools는 카탈로그 버전 2에 맞춰 제작된 프로그램이었고, 제가 읽고 싶은 카탈로그는 버전이 1이었습니다. 해당 부분을 수정하고, 카탈로그 1버전에는 존재하지 않는 것으로 보이는 부분을 삭제하였습니다. 그리고 디스코드에서 중요한 단서를 하나 얻었는데 "the other thing is that the catalog I was trying to convert was binary version 1 instead of 2, and from what I could gather most of the differences seem to be in the dynamic string encoding - specifically that the parts aren't reversed like in v2" 즉 카탈로그 버전 1은 다이나믹 스트링이 뒤집힌채로 출력된다는 점이었습니다. 이를 코드에 적용하고, 기존 제작자가 발견하지 못한 문제 몇 가지를 수정하자 카탈로그가 정상적으로 파싱되었습니다. 저는 해당 내용을 현재 툴을 유지보수 중인 LukeFZ에게 전달하였고, 이 내용은 그 분의 추가 수정과 같이 반영되었습니다.<br>
<br>
굉장히 기이한 점은 카탈로그에는 사라진 파일들이 정상적으로 존재하는 것으로 나온다는 점이었습니다. 이 파일들이 실제로 호출되는지 확인하기 위해 frida를 이용하여 에셋 번들 로드 함수를 후킹하였고, 유니티 엔진이 해당 경로로 파일들을 호출한다는 점을 발견하였습니다. 그래서 저는 해당 프로그램이 어디서 파일들을 읽어오는지 확인하기 위해 Process Acitivity View를 이용하였고, 특이한 파일 하나를 발견하게 되었습니다.<br>
<br>
### 가상 파일 시스템
![GFL2VFS](assets/gfl2vfs.png)
번들인 척 숨어있는 이 파일. dll을 살펴본 결과 08dfe7d89b6fe56375d6dfec87ffcc8a 라는 이름은 AssetBundleFileSystem의 MD5 해쉬임을 알게 되었습니다. 저는 이 파일이 사라진 번들의 행방을 알고 있는 핵심 파일이라고 생각하였고, 매 버전마다 CDN에서 새로 다운받아온다는 사실까지 확인하였습니다. 해당 파일의 코드를 재구성하여 확인한 결과, 리스트에는 약 12000개의 번들이 적혀있었고 이 중 제가 찾고 있는 것으로 추정되는 번들을 리스트에서 삭제하자 게임이 더이상 해당 번들을 로드하지 못한다는 점까지 확인하였습니다. 하지만 해당 파일 시스템의 코드는 현재 클라이언트와는 상당히 차이가 있는 것으로 보였고 저는 여기서 다른 데이터마이너들에게 도움을 요청하였습니다.<br>
<br>
다음 날, LukeFZ가 해당 파일의 비밀을 알아냈다는 소식을 알려왔습니다. 실제로 이 파일은 게임 내에서 가상 에셋 번들을 로드하는데에 쓰이는 파일이었으며, 알고보니 제작자들이 512kb 이하의 번들들을 다른 번들의 내부에 암호화해서 숨겨두는 방식을 사용하였던 것입니다. 기존 번들들은 그 자체로도 정상작동하도록 헤더가 모두 수정되어 있었고, 그 사이사이 공백에 번들들을 끼워둔 후 가상 파일 시스템에 해당 번들을 가지고 있는 번들의 이름과 오프셋을 기록해둔 것입니다.<br>
![GFL2Books](assets/gfl2books.png)
덕분에 저는 제가 원하던 AdvImportBook 스크립트들을 찾을 수 있었습니다. 이 파일들은 모두 따로 파싱하여, 화자-대사만 기록된 csv 파일들로 변환하였습니다.