---
title: >
    Unity HybridCLR 탐구
tags: [Unity]
style: border
color: primary
description: >
    최근 다양한 게임에서 사용되고 있는 핫 업데이트 솔루션 HybridCLR 탐구
---

[HybridCLR](https://github.com/focus-creative-games/hybridclr_unity) 은 중국에서 개발된 듯한 유니티 핫 업데이트 솔루션으로, 유니티 빌드와 함께 모든 dll을 릴리즈하는 것이 아니라 일부 dll을 런타임 도중에 로드하여 사용할 수 있는 패키지입니다. 개발사의 설명에 따르면 거의 완벽한 핫 리로드 솔루션으로 멀티 쓰레딩, 유니티 엔진에서 사용하는 MonoBehaviour, ScriptableObject, 데이터 지향 기술 스택 (DOTS - 네이티브 코드 컴파일러, 잡 시스템 등등), 여러 스크립트를 참조하는 리소스들이 업데이트된 코드에 맞춰서 동작하도록 보장한다고 하며, 내부적으로는 기존 il2cpp가 사용하는 AOT 런타임에 인터프리터 모듈을 제공하여 AOT + Interpreter 구조를 만든다고 합니다.<br>
<br>
![dnSpy로 dll 로드](assets/hybridclr.png)
신기하게도 il2cpp와 완벽히 결합되는 모습을 보이며, 비즈니스 버전의 경우 핫 업데이트된 dll들의 메타데이터를 읽은 다음 내부에서 코드가 실행되면 암호화된 메소드 바디를 복호화하여 실행하는 방식이기 때문에 dll을 덤프하는 것도 불가능하고, frida 같이 프로그램에 후킹하여 il2cpp 정보를 읽어내거나 코드를 실행할 수 있는 프레임워크는 HybridCLR로 로드된 dll의 메타데이터를 제대로 해석해내지 못하기 때문에 처음 빌드 때 포함된 일부의 함수를 제외하고 게임에 핵심적인 코드에는 접근하지 못하는 모습을 보입니다.<br>
사진에서 보실 수 있듯, dnSpy도 메소드 바디가 XOR로 추정되는 어떠한 방식으로 암호화되어 있기 때문에 클래스 구조만 파악 가능하고 제대로 된 분석을 하지 못합니다.<br>
<br>
개발사에 따르면 프로그래머들이 전혀 내부적으로 어떻게 동작하는지 알 필요 없이 단순히 패키지를 설치하고, 어셈블리를 지정하기만 하면 바로 HybridCLR 전용 AOT 파일이 컴파일되기 때문에 학습 곡선 또한 제로라고 주장하는데, 이런 기술이 유니티 게임들에 적용된다면 데이터마이닝이 굉장히 어려워지지 않을까 합니다.<br>

![샘플 프로젝트](assets/hybridclr2.png)
![샘플 프로젝트](assets/hybridclr3.png)

저도 궁금해서 패키지를 설치하고, 퀵 스타트 가이드를 따라해보았는데 단순히 어셈블리 정의 파일을 만들어주고 HybridCLR 세팅에 추가한 뒤 컴파일 과정을 따라했을 뿐인데 AOT dll 파일을 StreamingAssets 폴더에 놓고 런타임에서 추가적으로 로드할 수 있었습니다.