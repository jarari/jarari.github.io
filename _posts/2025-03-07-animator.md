---
title: >
    Unity Animator
tags: [Unity]
style: border
color: primary
description: >
    애니메이터의 이모저모
---

![Animator](assets/animator.png)

애니메이터는 간단히 표현하면 유니티 게임에서 애니메이션 클립을 재생해주는 컴포넌트 입니다. 유한 상태 기계 (Finite-State Machine) 모델을 취하고 있으며, 여기에 추가적으로 레이어를 구성하여 여러 개의 유한 상태 기계가 동시에 동작하게 할 수 있습니다.<br>
Entry에서 시작한 애니메이터는 바로 첫번째 스테이트로 이동하게 됩니다. 이후 파라미터에 정의된 여러 변수와 이 변수들을 사용하는 트랜지션을 통해 스테이트들을 오갈 수 있으며, 이 때 3D 오브젝트를 애니메이팅 할 때에는 스테이트를 오가는 시점과 조건, 블렌딩 되는 정도 등등 여러 옵션을 자연스럽게 지정해주어야 좀 더 좋은 결과물을 얻을 수 있습니다.

### 레이어

![레이어](assets/animator2.png)

레이어는 애니메이터가 여러 상태를 동시에 가지게 해줍니다. 이렇게 되면 여러가지 애니메이션 클립이 동시에 재생되게 되는데, 이 클립들이 블렌딩 되는 정도는 각 레이어에 있는 Weight를 통해 정의해 줄 수 있으며, 블렌딩 타입또한 Override 혹은 Additive 중에 고를 수 있습니다. 모든 레이어가 오버라이드인 상태에서 웨이트가 1로 지정되면 맨 아래에 있는 레이어의 클립이 모든 변경점을 덮어쓰게 되지만, 만약 레이어들에서 재생되는 클립에 겹치는 변경점이 없다면 모든 변경점이 같이 출력되게 됩니다.<br>
하지만, 애니메이션 클립들은 대게 캐릭터의 전신에 변경점을 가하는 경우가 많기 때문에 이럴 때엔 레이어별로 아바타 마스크를 지정하여 해당 레이어의 클립이 아바타의 어느 지점들에 적용될 것인지 지정할 수 있습니다. 또한, 어디티브 레이어를 이용하면 해당 클립의 0프레임 혹은 별도로 지정된 레퍼런스 포즈를 기준으로 발생하는 변경점을 애니메이터가 추가적으로 얹어주게 되는데 이런 구성도 유용하게 사용될 수 있습니다.

![마스크](assets/animator3.png)

저는 TPS 캐릭터를 구성할 때 전신에 클립을 재생하는 UpperBody 레이어, 상반신에 추가적인 어디티브 애니메이션을 재생할 UpperBodyAdditive 레이어, 로코모션을 담당할 LowerBody 레이어를 만든 후 LowerBody 레이어에는 휴머노이드 아바타 기준 하반신과 하반신 IK에 해당되는 마스크를 씌워 걸어다니면서 격발, 재장전, 수류탄 투척이 가능한 캐릭터를 구현하였습니다. 만약 필요한 경우, UpperBodyAdditive 레이어에 수직 손잡이 어디티브 클립을 추가하여 수직 손잡이 장착/미장착 애니메이션도 구현할 수 있습니다.<br>
다만 이러한 구성을 사용할 때에는 레이어들이 개별적인 트랜지션과 스테이트를 통해 동작한다는 점을 잘 이해하고 계획적으로 설계하여야 의도하지 않은 블렌딩 오류나 조작상의 문제를 방지할 수 있습니다.

### 블렌드 트리

![8방향 로코모션](assets/animator4.png)

블렌드 트리를 사용하면 하나의 스테이트에서 파라미터에 따라 여러가지 모션을 블렌딩하여 출력해줄 수 있습니다.<br>
제 TPS 캐릭터는 360도 회전하며 정면으로 달릴 수도 있지만, 조준하며 움직일 때 8방향 로코모션도 지원해줘야 했으므로 블렌드 트리를 활용하여 이를 구현하였습니다. 플레이어의 입력이 들어왔을 때, 캐릭터를 서서히 카메라 기준 앞, 뒤, 좌, 우로 가속하고 해당 가속도 벡터를 기준으로 Horizontal, Vertical 파라미터를 정해준 뒤 Speed 파라미터로 캐릭터가 8가지 방향으로 걷는 속도를 자연스럽게 조절해주었습니다.

![1D 파라미터](assets/animator5.png)

8방향 로코모션이 없는 캐릭터들의 경우에는 1D 블렌드로 스피드 파라미터만 사용하여 속도에 맞게 애니메이션을 재생해주었습니다.

### 아바타

![아바타 설정](assets/animator6.png)

아바타는 모델을 이용하여 제작할 수 있는 뼈 매핑 설정으로, 모델 간 불규칙한 뼈의 명칭을 유니티에서 지정한 일정한 이름 형식으로 치환해줄 수 있습니다. 가장 유용한 사용처는 애니메이션 클립을 임포트 할 때 설정으로 아바타를 지정할 수 있는데, 이렇게 아바타를 지정한 경우 애니메이션 클립 내부에서 사용되는 뼈들의 명칭과 트랜스폼이 해당 아바타에 맞춰 변경되기 때문에 전혀 비율이 다른 모델들 간에도 어느정도 구조가 일치한다면 애니메이션을 공유할 수 있게, 자체적인 리타게팅 기능을 제공해줍니다.<br>
웬만한 경우에는 Humanoid로 타입을 지정하여 유니티에게 모든 것을 맡기면 되지만, 프로젝트의 규모가 커지고 모델이 복잡해진다면 Generic을 통해 직접 매핑을 만들어주어야 합니다. 특히 최신 게임들의 경우 의상이나 헤어에 물리 효과를 위해 뼈대를 많이 추가하기 때문에 이 경우에는 직접 매핑을 해줘야 합니다.

### 트랜지션

![트랜지션](assets/animator7.png)

트랜지션은 애니메이터의 스테이트를 제어하는 역할을 하며, Has Exit Time이 체크된 경우 애니메이션이 특정 진행도를 만족하는 시점에, 혹은 Conditions 가 설정된 경우 조건을 만족하는 시점에 다른 스테이트로 전환이 일어나도록 유도합니다. Fixed Duration을 체크하면 초 단위, 체크하지 않으면 해당 애니메이션 길이의 일정 퍼센티지에 걸쳐 전환이 일어나게 되고, Interruption Source를 지정한 경우 전환 도중 방금까지 있던 스테이트나 목적지 스테이트에서 발생한 트랜지션이 현재의 트랜지션을 방해하여 바로 다음 트랜지션으로 넘어가게 될 수 있습니다. Any State가 항상 최상위 큐를 가지기 때문에 Ordered Interruption을 체크한 경우 Any State의 조건이 만족되었는지 판별 후 스테이트에 지정된 트랜지션의 순서에 따라 조건을 판별해서 또 다른 전환이 일어나게 됩니다.

### 애니메이터 컴포넌트

![애니메이터](assets/animator8.png)

애니메이터 컴포넌트에서는 사용할 애니메이터 컨트롤러, 아바타, 루트 모션 사용 여부, 업데이트 주기, 렌더링에 따른 갱신 여부를 지정할 수 있습니다. 저같은 경우에는 유니티 캐릭터 컨트롤러 컴포넌트 대신 루트 모션이 캐릭터의 위치를 제어하도록 만들었기 때문에 루트 모션을 사용하도록 하고, Rigid body 기반 물리 시스템과의 동기화 문제를 해결해주기 위하여 Animate Physics 로 업데이트 모드를, 그리고 오브젝트가 렌더링되지 않는 경우에도 애니메이션은 계속되고 있어야 하지만 완벽한 업데이트까진 필요가 없기 때문에 Cull Update Transforms로 지정해주었습니다.<br>
상황에 따라 타임스케일이 조정되는 경우 업데이트 모드를 변경해주는 경우도 있었으며, 특히 타임스케일을 과도하게 느리게 만드는 경우 fixedTime의 업데이트 주기가 일치하지 않아 애니메이션이 끊겨보이는 문제가 있어 이러한 경우에도 업데이트 모드를 잠시 변경해주었습니다.<br>