---
title: >
    Animation Rigging
tags: [Unity]
style: border
color: primary
description: >
    애니메이션 리깅 패키지를 이용한 IK와 컨스트레인츠
---

![패키지](assets/animrig.png)

애니메이션 리깅 패키지는 애니메이터가 클립을 재생 한 후 추가적으로 구성에 따라 변형을 가하여 절차적 애니메이션 생성을 도와주는 패키지입니다. 보통 애니메이션 리소스의 경우 모델과 모델이 사용할 도구에 정확히 애니메이션이 맞물리도록 제작되는 것이 기본이지만, 여러 소스를 모아 작업하다 보면 맞춤형 애니메이션을 만들기가 쉽지는 않습니다. 또한, 맞춰서 만들어진 애니메이션들의 경우에도 땅을 짚고 올라간다던지 계단을 오른다던지 옆의 벽을 짚는다던지 이러한 특수한 경우에는 환경에 맞는 후처리가 필요한 경우가 있습니다. 이러한 상황에서 애니메이션 리깅 패키지가 어떻게 사용될 수 있는지 정리 해보았습니다.

### 무기와 애니메이션의 불일치

![Mixamo 모델](assets/animrig2.png)

Mixamo는 모델과 애니메이션을 구하기는 정말 좋은 사이트이지만, 애니메이션들의 퀄리티가 그렇게 좋지는 않습니다. 저는 SWAT 모델과 총을 조준하는 애니메이션을 받아와 캐릭터를 구성해 보았는데, 모델에 총기가 포함되어 있지 않아 급한대로 스케치팹에서 구한 레밍턴 ACR 모델을 손에 들려주었습니다.<br>
문제는 각도를 어떻게 맞춰봐도 왼손과 오른손을 총에 맞게 끼우는게 불가능했습니다.<br>
이 때 제가 이용한 것이 애니메이션 리깅 패키지의 Two Bone IK Constraint 입니다.

![Rig Setup](assets/animrig3.png)

애니메이션 리깅 패키지를 사용하기 위해선 사전 작업이 필요합니다. 애니메이터를 선택하고 Animation Rigging->Rig Setup을 눌러 Rig 오브젝트와 컴포넌트를 추가시켜주는 것인데요. 여기서 주의할 점은

* Animator
  * Rig
    * Constraints

위와 같은 hierarchy 구조가 깨진다면 패키지가 작동하지 않는다는 점입니다.<br>

![Two Bone IK](assets/animrig4.png)

이제 위 사진처럼 Rig에 빈 게임 오브젝트를 추가하고 Two Bone IK Constraint 컴포넌트를 추가해준 후 Root, Mid, Tip은 각각 왼쪽 윗팔, 팔꿈치, 손에 할당해주면 됩니다. 그 다음 Two Bone IK Constraint의 맨 우측 점 3개를 누르고 Auto Setup from Tip Transform을 누르면 Target과 Hint로 사용될 오브젝트들이 생성됩니다.

![IK in Action](assets/animrig5.png)

애니메이션 프리뷰로 들어가면 리깅 패키지가 작동하여 왼손이 LHandIK_target을 향하도록 조종합니다. 이제 여기서 LHandIK_target의 위치를 조정하여 왼손이 총을 잡도록 해주고 타겟을 총이나 오른손 뼈의 자식으로 등록해주면

![총을 쥐다](assets/animrig6.png)

총을 정확히 쥐고 있게 됩니다.

![재장전](assets/animrig7.png)

저는 이것을 응용하여 재장전 애니메이션에 여러가지 컨스트레인츠의 비중을 조작하는 방식으로 왼손이 정확히 탄창을 집고, 탄창이 왼손에 고정되고, 다시 정확한 위치에 삽입 후 장전 손잡이를 당기는 것까지 총기와 자연스럽게 일치하도록 애니메이션 클립을 조정해주었습니다.

### 무기 스위칭

![수류탄 투척](assets/animrig8.png)

제 기획상 SWAT 캐릭터는 총기를 기본 공격으로, 스킬은 수류탄을 투척하고 궁극기는 에너지 유탄발사기를 사용하는 컨셉이었습니다. 자연스럽게 몸에 달려있는 수류탄을 집고, 왼손으로 총을 들고, 수류탄을 던지고 복귀하는 모든 과정을 애니메이션 리깅 패키지의 Multi-Parent Constraint를 통해 구현할 수 있었습니다.

![수류탄 어태치 포인트](assets/animrig9.png)

Hips 뼈를 따라다니는 수류탄 기준점 오브젝트와 RightHand 뼈를 따라다니는 수류탄 기준점 오브젝트 두 개를 만들어놓고

![수류탄 어태치 포인트 전환](assets/animrig10.png)

Multi-Parent Constraint의 소스 오브젝트로 등록한 후 각각의 비중을 조절하기만 하면 수류탄이 허리에 달렸다 손으로 갔다 자유자재로 가능합니다. 비중 조절도 애니메이션 클립에 녹화할 수 있기 때문에 이를 이용하여 손이 허리춤에 가는 순간 컨스트레인츠의 비중을 손으로 옮겨주고, 던지고 난 후에는 다시 허리로 돌려놓아 스킬이 준비되었을 때 수류탄이 허리춤에 달려있도록 하였습니다.

![에너지 유탄발사기](assets/animrig11.png)

궁극기 모션 또한 유탄발사기에 손을 얹는 순간 유탄발사기를 손에 부착시켜 무기 전환을 구현하였습니다.

### 무기 조준

![조준 블렌드](assets/animrig12.png)

제가 생각하던 무기 조준 애니메이션은 땅 아래를 조준하는 애니메이션, 가운데를 조준하는 애니메이션, 그리고 하늘을 조준하는 애니메이션을 1D 블렌드로 구현하는 것이었으나, Mixamo에서 구해온 모션에는 아래와 하늘을 조준하는 애니메이션이 포함되어 있지 않았습니다.

![조준 구현](assets/animrig13.png)

그리고 리깅 패키지의 Multi-Aim Constraint가 이걸 완벽해 해결해주었습니다. Hierarchy의 위->아래 순서대로 실행되는 패키지 특성 상 가슴-머리-손의 순서로 멀티 에임 컨스트레인츠가 동작하게 구성하였고, 자연스러운 회전을 위해 어느정도의 각도 제한과 조준점에 오프셋을 주었습니다.

![조준 구현2](assets/animrig14.png)