---
name: Shield Framework
tools: [C++]
image: assets/shieldframework.png
description: 폴아웃 4에 투사체 및 물리 공격을 방어하는 방패 시스템을 구현하는 프레임워크
---

# Shield Framework

스카이림의 모딩 방향이 판타지를 추구한다면 폴아웃 4의 플레이어들은 약간 다릅니다.<br>
그들은 매우 현실적이고, 전술적인 건 파이트 시뮬레이터를 원하죠.<br>
그런데 이런 환경에 콜 오브 듀티 스타일의 전술 방패가 없다는건 정말 유저들의 오랜 숙원이었습니다.<br>
<br>
이를 위해 저는 크리에이션 엔진에서 사용하는 Havok 물리 엔진을 이용하여<br>
투사체와 근접 공격을 감지 할 수 있는 플레이어에게 장착되는 충돌체를 추가하고<br>
이에 필요한 데이터들을 구성하여 장착할 수 있는 전술 방패를 구현하였습니다.<br>
또한, 해당 데이터들을 유저들이 직접 추가하고 커스텀 할 수 있게 기능을 확장하여<br>
무기나 방어구 어떤 형태와 모양, 재질의 방패든 직접 추가할 수 있는 프레임워크를 제작하였습니다.<br>

<p class="text-center">
{% include elements/button.html link="https://github.com/jarari/ShieldFramework" text="프로젝트 GitHub" %}
</p>

## 개발 난관들
<br>
### 1. Havok 충돌체의 콜리전 필터

![콜리전 필터 설정](assets/shieldframework_inithavok.png)
폴아웃 4에서는 무기가 플레이어에게 장착될 때, 충돌체가 방패 오브젝트가 아닌 경우<br>
투사체와 충돌이 일어나지 않도록 콜리전 필터가 설정되고 있었습니다.<br>
여기서 "방패 오브젝트" 라는 표현이 조금 문제인데, 이 방패는 사실 스카이림의 방패를 가리킵니다.<br>
엔진 코드를 재사용하면서 방패 관련 코드가 일부 넘어온 것인데, 이는 거의 더미 데이터에 가까우며<br>
제가 사용하려는 의도와도 일치하지 않았습니다.<br>
그러므로 저는 프레임워크에 등록된 방패 장착 시, 해당 방패 데이터에 맞도록 충돌체를 Havok 월드에 새로 생성하고, 콜리전 필터 및 모션 타입 설정까지 적절하게 해주었습니다.<br>
<br>
### 2. 1인칭과 3인칭간 좌표 불일치

![1인칭 카메라와 3인칭 모델](assets/shieldframework_skelmismatch.png)
3인칭 시점에서는 문제가 없는데 1인칭 시점에서는 자꾸 방패를 뚫고 데미지가 들어오는 문제가 발생했습니다.<br>
이유가 무엇인가, 연구해보았더니 폴아웃 4에선 1인칭과 3인칭용 biped가 따로 존재하는데,<br>
히트박스는 3인칭 biped에만 존재하고, 시점을 1인칭으로 전환하면 3인칭 biped의 애니메이션 시스템이 비활성화 되면서 좌표가 불일치하였기 때문입니다.<br>
이를 해결하기 위하여, 저는 1인칭과 3인칭 사이의 좌표 차이를 보정하고 트래킹할 bone의 리스트를 만들어서 1인칭과 3인칭 biped 간의 오차를 제거하였습니다.<br>
![1인칭 카메라와 3인칭 모델 보정](assets/shieldframework_skelmismatch2.png)
오차를 보정해준 이후에는 1인칭과 3인칭 모델이 정확히 겹쳐지는 것을 확인하실 수 있습니다.<br>
<br>
### 3. 엔진 내 하드코딩 데이터들

![임팩트 데이터](assets/shieldframework_hardcoded.png)
투사체가 오브젝트와 충돌할 때의 이펙트가 특정 조건에 의해 덮어씌워지거나,<br>
게임 내 특정 레코드를 참조하도록 만들어진 것도 제가 해결해야 할 과제였습니다.<br>
그 중 하나의 예로, 폴아웃 4의 NPC들은 종족을 기반으로 외형이나 특성들을 상속받는데<br>
NPC가 투사체에 맞은 경우, 어디에 맞았든 NPC의 종족에 지정된 타격 이펙트를 사용하도록 프로그래밍 된 부분이 있었습니다.<br>
이 부분은 하는 수 없이 jmp로 덮어씌워 조건문을 무시하도록 처리해주었습니다.<br>
또한, 유저가 추가한 투사체-충돌체 임팩트 데이터를 런타임 때 하드코딩 된 레코드로 추가 삽입 해주도록 처리했습니다.<br>
<br>
### 4. 애니메이션

![공격 모션](assets/shieldframework_anim.gif)
![공격 모션2](assets/shieldframework_anim2.gif)
근접 무기는 1인칭, 3인칭을 모두 포함하여 약 230개의 애니메이션이 필요합니다.<br>
방패는 폴아웃 4 내에 아에 존재하지 않던 타입이기 때문에 새로운 애니메이션을 만들어줘야 했습니다.<br>
1인칭 애니메이션의 경우 외국 모더의 도움을 받아 모던워페어 2의 애니메이션을 포팅했고<br>
나머지 200개의 3인칭 애니메이션은 기존 애니메이션을 참고하여 3ds Max로 새로 제작했습니다.<br>
<br>
### 결과물

{% include elements/video.html id="LrLbN7csBsQ" %}
최종적으로 게임 내에 구현된 결과물입니다.<br>
방패의 몸통과 유리부분이 투사체에 다른 임팩트 데이터를 출력하며,<br>
근접 공격 데미지 또한 잘 상쇄하는 것을 볼 수 있습니다.<br>
방패로 막지 않았을 때 플레이어가 바로 사망하는 모습도 확인하실 수 있습니다.